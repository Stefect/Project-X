<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';">
  <title>BrowserX</title>
  <link rel="stylesheet" href="css/output.css">
</head>
<body>
  <!-- Панель вкладок з кнопками вікна -->
  <div class="tabs-bar" id="tabs-bar">
    <div class="menu-section">
      <button class="menu-btn" id="menu-btn" title="Меню">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M1 2h14v2H1V2zm0 5h14v2H1V7zm0 5h14v2H1v-2z"/>
        </svg>
      </button>
      <span class="logo">BrowserX</span>
    </div>
    <div class="tabs-container">
      <div class="tab active" data-tab-id="1">
        <img class="tab-favicon" src="https://www.google.com/favicon.ico" onerror="this.style.display='none'">
        <span class="tab-title">Нова вкладка</span>
        <span class="tab-close"></span>
      </div>
      <button class="new-tab-btn" id="new-tab-btn" title="Нова вкладка (Ctrl+T)">+</button>
    </div>
    
    <!-- Кнопки керування вікном -->
    <div class="window-controls">
      <button class="window-btn" id="minimize-btn" title="Згорнути">
        <svg width="10" height="1" viewBox="0 0 10 1"><path fill="currentColor" d="M0 0h10v1H0z"/></svg>
      </button>
      <button class="window-btn" id="maximize-btn" title="Розгорнути">
        <svg width="10" height="10" viewBox="0 0 10 10"><path fill="currentColor" d="M0 0v10h10V0H0zm1 1h8v8H1V1z"/></svg>
      </button>
      <button class="window-btn close" id="close-btn" title="Закрити">
        <svg width="10" height="10" viewBox="0 0 10 10"><path fill="currentColor" d="M0 0l1-1 4 4 4-4 1 1-4 4 4 4-1 1-4-4-4 4-1-1 4-4z"/></svg>
      </button>
    </div>
  </div>

  <div class="toolbar">
    <button class="nav-button" id="back" title="Назад">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 14L4 8l6-6"/>
      </svg>
    </button>
    <button class="nav-button" id="forward" title="Вперед">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 14l6-6-6-6"/>
      </svg>
    </button>
    <button class="nav-button" id="reload" title="Оновити">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M13 8c0-2.76-2.24-5-5-5-1.5 0-2.85.66-3.77 1.7L2 2v5h5L4.5 4.5C5.2 3.6 6.5 3 8 3c2.21 0 4 1.79 4 4s-1.79 4-4 4c-1.11 0-2.11-.45-2.83-1.17L3.76 11.24C4.82 12.3 6.33 13 8 13c2.76 0 5-2.24 5-5z"/>
      </svg>
    </button>
    <input type="text" class="address-bar" id="url" placeholder="Google пошук або введіть адресу">
    <button class="organize-btn" id="organize-tabs-btn" title="AI організація вкладок">Організувати</button>
    <button class="nav-button" id="tor-btn" title="Перемкнути Tor" style="font-weight: 600; color: #9ca3af;">
      Tor: OFF
    </button>
    <!-- Settings button removed (Simple Settings UI deprecated) -->
    <button class="smart-search-btn" id="theme-settings-btn" title="Налаштувати вигляд" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 50%;">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="white">
        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 13A6 6 0 0 1 8 2a6 6 0 0 1 0 12z"/>
        <circle cx="8" cy="8" r="3" fill="white"/>
      </svg>
    </button>
    <button class="smart-search-btn" id="toggle-sidebar-toolbar" title="Показати/сховати конспект (Ctrl+B)">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M3 2h10c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1H3c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1zm0 2v8h10V4H3zm2 2h6v1H5V6zm0 2h6v1H5V8zm0 2h4v1H5v-1z"/>
      </svg>
    </button>
  </div>

  <!-- Випадаюче меню -->
  <div class="dropdown-menu" id="dropdown-menu">
    <button class="menu-item">
      <span class="label">Нова вкладка</span>
      <span class="shortcut">CTRL + T</span>
    </button>
    <button class="menu-item">
      <span class="label">Нова вкладка в острові вкладок</span>
      <span class="shortcut">ALT + T</span>
    </button>
    <button class="menu-item">
      <span class="label">Нове вікно</span>
      <span class="shortcut">CTRL + N</span>
    </button>
    <button class="menu-item">
      <span class="label">Нове конфіденційне вікно</span>
      <span class="shortcut">CTRL + SHIFT + N</span>
    </button>

    <div class="menu-separator"></div>

    <button class="menu-item has-submenu">
      <span class="label">Сторінка</span>
    </button>

    <div class="menu-separator"></div>

    <div class="zoom-controls">
      <button class="zoom-btn" id="zoom-out">−</button>
      <div class="zoom-value" id="zoom-value">100%</div>
      <button class="zoom-btn" id="zoom-in">+</button>
      <button class="zoom-btn" id="zoom-reset" title="Скинути масштаб">⟲</button>
      <button class="zoom-btn" id="fullscreen" title="Повноекранний режим"></button>
    </div>

    <div class="menu-separator"></div>

    <button class="menu-item">
      <span class="label">Масштаб</span>
    </button>
    <button class="menu-item">
      <span class="label">Знайти...</span>
      <span class="shortcut">CTRL + F</span>
    </button>
    <button class="menu-item">
      <span class="label">Вкладки пошуку</span>
      <span class="shortcut">CTRL + SPACE</span>
    </button>
    <button class="menu-item">
      <span class="label">Знімок</span>
      <span class="shortcut">CTRL + SHIFT + 5</span>
    </button>

    <div class="menu-separator"></div>

    <button class="menu-item has-submenu">
      <span class="label">Журнал</span>
    </button>
    <button class="menu-item">
      <span class="label">Завантаження</span>
      <span class="shortcut">CTRL + J</span>
    </button>
    <button class="menu-item has-submenu">
      <span class="label">Закладки</span>
    </button>
    <button class="menu-item has-submenu">
      <span class="label">Розширення</span>
    </button>
    <button class="menu-item has-submenu">
      <span class="label">Новини</span>
    </button>
    <button class="menu-item">
      <span class="label">Pinboards</span>
    </button>
    <button class="menu-item">
      <span class="label">Увійти в Обліковий запис Opera...</span>
    </button>

    <div class="menu-separator"></div>

    <button class="menu-item has-submenu">
      <span class="label">Розробник</span>
    </button>

    <div class="menu-separator"></div>

    <button class="menu-item" id="customize-menu">
      <span class="label">Налаштувати вигляд</span>
      <span class="shortcut">CTRL + SHIFT + Y</span>
    </button>
    <button class="menu-item">
      <span class="label">Параметри</span>
      <span class="shortcut">ALT + P</span>
    </button>
    <button class="menu-item has-submenu">
      <span class="label">Довідка</span>
    </button>
    <button class="menu-item has-submenu">
      <span class="label">Профілі</span>
    </button>
    <button class="menu-item">
      <span class="label">Оновлення та відновлення...</span>
    </button>

    <div class="menu-separator"></div>

    <button class="menu-item" id="exit-browser">
      <span class="label">Вийти</span>
    </button>
  </div>

  <!-- Overlay для панелі -->
  <div class="panel-overlay" id="panel-overlay"></div>

  <!-- НОВА Панель налаштувань -->
  <div id="theme-panel" class="side-panel">
    <div class="panel-header">
      <h3>Налаштувати вигляд</h3>
      <button class="close-panel-btn" id="close-panel-btn"></button>
    </div>

    <div class="panel-content">
      <!-- Preview Box -->
      <div class="preview-box" id="preview-box">
        <div class="preview-mini-browser">
          <div class="preview-mini-tabs">
            <div class="preview-mini-tab"></div>
          </div>
          <div class="preview-mini-toolbar">
            <div class="preview-mini-btn"></div>
            <div class="preview-mini-btn"></div>
            <div class="preview-mini-btn"></div>
            <div class="preview-mini-url"></div>
          </div>
          <div class="preview-mini-content"></div>
        </div>
      </div>

      <!-- Mode Switch -->
      <div class="mode-switch">
        <button class="mode-btn" data-mode="light"> Світла</button>
        <button class="mode-btn active" data-mode="dark"> Темна</button>
        <button class="mode-btn" data-mode="system"> Система</button>
      </div>

      <!-- Color Grid - СПЛІТ КРУЖЕЧКИ -->
      <h4 class="section-title">Колірна гама</h4>
      <div class="color-grid" id="color-grid">
        <!-- Синій + білий -->
        <button class="color-option active" data-bg="#1a1b26" data-accent="#3b82f6" style="background: linear-gradient(135deg, #3b82f6 50%, #1e3a5f 50%);"></button>
        <!-- Бірюзовий -->
        <button class="color-option" data-bg="#1a2e2e" data-accent="#14b8a6" style="background: linear-gradient(135deg, #14b8a6 50%, #134e4a 50%);"></button>
        <!-- Зелений -->
        <button class="color-option" data-bg="#1a2e1a" data-accent="#22c55e" style="background: linear-gradient(135deg, #22c55e 50%, #166534 50%);"></button>
        <!-- Фіолетовий -->
        <button class="color-option" data-bg="#1e1a2e" data-accent="#8b5cf6" style="background: linear-gradient(135deg, #8b5cf6 50%, #4c1d95 50%);"></button>
        
        <!-- Рожевий -->
        <button class="color-option" data-bg="#2e1a2a" data-accent="#ec4899" style="background: linear-gradient(135deg, #ec4899 50%, #831843 50%);"></button>
        <!-- Червоний -->
        <button class="color-option" data-bg="#2e1a1a" data-accent="#ef4444" style="background: linear-gradient(135deg, #ef4444 50%, #7f1d1d 50%);"></button>
        <!-- Оранжевий -->
        <button class="color-option" data-bg="#2e2a1a" data-accent="#f97316" style="background: linear-gradient(135deg, #f97316 50%, #7c2d12 50%);"></button>
        <!-- Жовтий -->
        <button class="color-option" data-bg="#2e2e1a" data-accent="#eab308" style="background: linear-gradient(135deg, #eab308 50%, #713f12 50%);"></button>
        
        <!-- Сірий нейтральний -->
        <button class="color-option" data-bg="#1f1f1f" data-accent="#6b7280" style="background: linear-gradient(135deg, #6b7280 50%, #374151 50%);"></button>
        <!-- Лаймовий -->
        <button class="color-option" data-bg="#1a2e1a" data-accent="#84cc16" style="background: linear-gradient(135deg, #84cc16 50%, #3f6212 50%);"></button>
        <!-- Блакитний -->
        <button class="color-option" data-bg="#1a2a2e" data-accent="#06b6d4" style="background: linear-gradient(135deg, #06b6d4 50%, #155e75 50%);"></button>
        <!-- Кастомний -->
        <button class="color-option color-custom" data-bg="custom" data-accent="custom"></button>
      </div>

      <!-- Wallpapers Section -->
      <h4 class="section-title">Шпалери</h4>
      <div class="wallpaper-grid" id="wallpaper-grid">
        <!-- No wallpaper -->
        <div class="wallpaper-card active" data-wallpaper="none" style="background: linear-gradient(135deg, var(--theme-bg), var(--theme-surface));">
          <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 32px; opacity: 0.3;">∅</div>
        </div>
        
        <!-- Upload custom -->
        <div class="wallpaper-card upload-card" id="upload-wallpaper">
          <div class="upload-icon"></div>
          <div class="upload-text">Завантажити</div>
        </div>

        <!-- Preset wallpapers -->
        <div class="wallpaper-card" data-wallpaper="abstract1" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
        <div class="wallpaper-card" data-wallpaper="abstract2" style="background-image: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
        <div class="wallpaper-card" data-wallpaper="abstract3" style="background-image: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
        <div class="wallpaper-card" data-wallpaper="abstract4" style="background-image: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"></div>
        <div class="wallpaper-card" data-wallpaper="abstract5" style="background-image: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
        <div class="wallpaper-card" data-wallpaper="abstract6" style="background-image: linear-gradient(135deg, #30cfd0 0%, #330867 100%);"></div>
      </div>

      <div class="wallpaper-actions">
        <button class="wallpaper-btn" id="clear-wallpaper">Очистити шпалери</button>
        <button class="wallpaper-btn primary" id="upload-wallpaper-btn">Завантажити нову</button>
      </div>
      <input type="file" id="wallpaper-file-input" accept="image/*" style="display: none;">

      <!-- Settings Group -->
      <div class="settings-group">
        <h4 class="section-title">Налаштування</h4>
        <div class="settings-item">
          <span>Показувати кнопку "Головна"</span>
          <div class="toggle-switch active" id="home-btn-toggle"></div>
        </div>
        <div class="settings-item">
          <span>Показувати панель закладок</span>
          <div class="toggle-switch" id="bookmarks-toggle"></div>
        </div>
        <div class="settings-item">
          <span>Показувати ярлики на новій вкладці</span>
          <div class="toggle-switch active" id="shortcuts-toggle"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="main-content"></div>
    
    <div id="notes-sidebar" class="collapsed" style="width: 0; padding: 0; overflow: hidden; border-left: none;">
      <h3>
        <span>Мій Конспект</span>
        <button id="toggle-sidebar" title="Показати панель"></button>
      </h3>
      
      <div id="notes-list">
        <div class="empty-state">Виділіть текст на сторінці та<br>натисніть праву кнопку миші</div>
      </div>

      <button id="summarize-btn">Узагальнити через AI</button>
      <button id="clear-btn">Очистити все</button>
    </div>
  </div>

  <script>
    console.log(' JavaScript починає виконання');
    
    try {
      const { ipcRenderer } = require('electron');
      console.log(' IPC Renderer завантажено в main window');
      
      // ========== Кнопки керування вікном ==========
      const minimizeBtn = document.getElementById('minimize-btn');
      const maximizeBtn = document.getElementById('maximize-btn');
      const closeBtn = document.getElementById('close-btn');
      
      if (minimizeBtn) {
        minimizeBtn.addEventListener('click', () => {
          console.log(' Згортання вікна');
          ipcRenderer.send('window-minimize');
        });
      }
      
      if (maximizeBtn) {
        maximizeBtn.addEventListener('click', () => {
          console.log(' Розгортання вікна');
          ipcRenderer.send('window-maximize');
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          console.log(' Закриття вікна');
          ipcRenderer.send('window-close');
        });
      }
      
      const backBtn = document.getElementById('back');
      const forwardBtn = document.getElementById('forward');
      const reloadBtn = document.getElementById('reload');
      const urlInput = document.getElementById('url');
      const notesList = document.getElementById('notes-list');
      const summarizeBtn = document.getElementById('summarize-btn');
      const clearBtn = document.getElementById('clear-btn');
      
      // Toggle бокової панелі
      const notesSidebar = document.getElementById('notes-sidebar');
      const toggleSidebarBtn = document.getElementById('toggle-sidebar');
      const toggleSidebarToolbar = document.getElementById('toggle-sidebar-toolbar');
      const menuBtn = document.getElementById('menu-btn');
      
      // Вкладки
      const tabsBar = document.getElementById('tabs-bar');
      const tabsContainer = tabsBar.querySelector('.tabs-container');
      const newTabBtn = document.getElementById('new-tab-btn');
      
      let collectedNotes = [];
      
      // ВИДАЛЯЄМО старе значення з localStorage, щоб панель завжди була згорнута при запуску
      localStorage.removeItem('sidebarCollapsed');
      
      let isSidebarCollapsed = true; // Завжди згорнута за замовчуванням
      let currentTabId = 1; // Поточна активна вкладка
      
      // Завантаження нотаток з storage при запуску
      (async () => {
        try {
          const savedNotes = await ipcRenderer.invoke('get-notes');
          if (savedNotes && savedNotes.length > 0) {
            collectedNotes = savedNotes;
            
            // Очищуємо empty state
            notesList.innerHTML = '';
            
            // Відображаємо збережені нотатки
            savedNotes.forEach(note => {
              const noteItem = document.createElement('div');
              noteItem.className = 'note-item';
              noteItem.dataset.noteId = note.id;
              noteItem.innerHTML = `
                <span>• ${note.text}</span>
                <button class="delete-btn" onclick="deleteNote('${note.id}')"></button>
              `;
              notesList.appendChild(noteItem);
            });
            
            console.log('[NOTES] Завантажено нотаток:', savedNotes.length);
          }
        } catch (error) {
          console.error('[ERROR] Помилка завантаження нотаток:', error);
        }
      })();

      // ========== Система вкладок ==========
      
      // Створити нову вкладку
      async function createTab(url = null) {
      const result = await ipcRenderer.invoke('create-tab', url);
      
      // Створюємо візуальний елемент вкладки
      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.dataset.tabId = result.id;
      
      tabElement.innerHTML = `
        <img class="tab-favicon" src="https://www.google.com/favicon.ico" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22></text></svg>'">
        <span class="tab-title">${result.title}</span>
        <span class="tab-close"></span>
      `;
      
      // Додаємо перед кнопкою "+" в контейнер вкладок
      tabsContainer.insertBefore(tabElement, newTabBtn);
      
      // Перемикаємось на нову вкладку
      switchTab(result.id);
      
      return result.id;
      }
      
      // Перемкнутися на вкладку
      function switchTab(tabId) {
        // Отримуємо поточні кольори теми
        const currentBg = localStorage.getItem('themeBg') || '#1a1b26';
        const currentAccent = localStorage.getItem('themeAccent') || '#3b82f6';
        
        // Знімаємо клас active з усіх вкладок
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
          // Застосовуємо колір неактивної вкладки
          tab.style.background = lightenColorSimple(currentBg, 15);
          tab.style.borderColor = lightenColorSimple(currentBg, 25);
        });
        
        // Додаємо active до вибраної
        const targetTab = document.querySelector(`[data-tab-id="${tabId}"]`);
        if (targetTab) {
          targetTab.classList.add('active');
          // Застосовуємо колір акценту для активної вкладки
          targetTab.style.background = currentAccent;
          targetTab.style.borderColor = currentAccent;
          
          currentTabId = tabId;
          ipcRenderer.send('switch-tab', tabId);
        }
      }
      
      // Проста функція освітлення кольору для switchTab
      function lightenColorSimple(color, percent) {
        const num = parseInt(color.replace('#', ''), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.min(255, Math.max(0, (num >> 16) + amt));
        const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
        const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
        return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
      }
      
      // Закрити вкладку
      function closeTab(tabId) {
        const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
        if (tabElement) {
          tabElement.remove();
        }
        ipcRenderer.send('close-tab', tabId);
      }
      
      // Оновити інформацію вкладки (заголовок, favicon)
      ipcRenderer.on('update-tab-info', (event, tabId, title, url) => {
        const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
        if (tabElement) {
          const titleElement = tabElement.querySelector('.tab-title');
          const faviconElement = tabElement.querySelector('.tab-favicon');
          
          if (titleElement) titleElement.textContent = title || 'Нова вкладка';
          
          if (faviconElement && url) {
            const faviconUrl = new URL(url).origin + '/favicon.ico';
            faviconElement.src = faviconUrl;
          }
        }
      });
      
      // Оновити URL bar
      ipcRenderer.on('update-url-bar', (event, url) => {
        // Не показуємо локальні файли (newtab)
        if (url && (url.includes('newtab.html') || url.startsWith('file://'))) {
          urlInput.value = '';
        } else {
          urlInput.value = url;
        }
      });

      // Оновити назву вкладки
      ipcRenderer.on('update-tab-title', (event, data) => {
        const tabElement = document.querySelector(`[data-tab-id="${data.tabId}"]`);
        if (tabElement) {
          const titleElement = tabElement.querySelector('.tab-title');
          if (titleElement) {
            titleElement.textContent = data.title || 'Нова вкладка';
          }
        }
      });
      
      // Якщо всі вкладки закрито, створити нову
      ipcRenderer.on('create-default-tab', () => {
      createTab();
    });
    
    // Обробники подій для вкладок
    if (tabsBar) {
      tabsBar.addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if (!tab) return;
      
      const tabId = parseInt(tab.dataset.tabId);
      
      // Якщо клікнули на кнопку закриття
      if (e.target.classList.contains('tab-close')) {
        e.stopPropagation();
        closeTab(tabId);
      } else {
        // Перемкнутись на вкладку
        switchTab(tabId);
      }
    });
    }
    
    // Кнопка створення нової вкладки
    if (newTabBtn) {
        newTabBtn.addEventListener('click', () => {
        createTab();
      });
    }
    
    // Гаряча клавіша Ctrl+T для нової вкладки
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        createTab();
      }
    });

    // ========== Організація вкладок через AI ==========
    const organizeTabsBtn = document.getElementById('organize-tabs-btn');
    
    if (organizeTabsBtn) {
      organizeTabsBtn.addEventListener('click', async () => {
      const allTabs = document.querySelectorAll('.tab');
      
      if (allTabs.length < 2) {
        alert('Потрібно хоча б 2 вкладки для організації!');
        return;
      }

      // Показуємо індикатор завантаження
      organizeTabsBtn.innerHTML = ' Думаю...';
      organizeTabsBtn.disabled = true;

      try {
        const result = await ipcRenderer.invoke('organize-tabs');
        
        if (!result.success) {
          alert(result.message || ' Не вдалося згрупувати вкладки');
          organizeTabsBtn.innerHTML = ' Навести лад';
          organizeTabsBtn.disabled = false;
          return;
        }

        // Показуємо результат користувачу
        displayOrganizedGroups(result.groups, result.tabsData);
        
        organizeTabsBtn.innerHTML = ' Готово!';
        setTimeout(() => {
          organizeTabsBtn.innerHTML = ' Навести лад';
          organizeTabsBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Помилка організації:', error);
        alert('Помилка: ' + error.message);
        organizeTabsBtn.innerHTML = ' Навести лад';
        organizeTabsBtn.disabled = false;
      }
    });

    // Функція для відображення організованих груп
    function displayOrganizedGroups(groups, tabsData) {
      // Створюємо popup з результатами
      const popup = document.createElement('div');
      popup.id = 'organize-popup';
      popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 3px solid #10b981;
        border-radius: 16px;
        padding: 24px;
        max-width: 600px;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 1000000;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
        font-family: 'Segoe UI', sans-serif;
      `;
      
      let groupsHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #10b981; font-size: 22px;"> AI організував ваші вкладки</h2>
          <button id="close-organize-popup" style="
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
          "></button>
        </div>
      `;

      groups.forEach((group, idx) => {
        const groupColor = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'][idx % 5];
        
        groupsHTML += `
          <div style="
            margin-bottom: 16px; 
            padding: 16px; 
            background: linear-gradient(135deg, ${groupColor}15, ${groupColor}05);
            border-left: 4px solid ${groupColor};
            border-radius: 10px;
          ">
            <h3 style="margin: 0 0 12px 0; color: ${groupColor}; font-size: 16px; display: flex; align-items: center; gap: 8px;">
               ${group.name}
              <span style="font-size: 12px; color: #666; font-weight: normal;">(${group.tabIds.length} вкладок)</span>
            </h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
        `;

        group.tabIds.forEach(tabId => {
          const tabData = tabsData.find(t => t.id === tabId);
          if (tabData) {
            groupsHTML += `
              <div style="
                padding: 10px 12px;
                background: white;
                border-radius: 6px;
                font-size: 13px;
                color: #334155;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 10px;
              ">
                <img src="https://www.google.com/s2/favicons?domain=${new URL(tabData.url || 'https://google.com').hostname}" 
                     width="16" height="16" 
                     onerror="this.style.display='none'"
                     style="flex-shrink: 0;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; color: ${groupColor}; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${tabData.title}
                  </div>
                  <div style="font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${tabData.url}
                  </div>
                </div>
              </div>
            `;
          }
        });

        groupsHTML += `
            </div>
          </div>
        `;
      });

      groupsHTML += `
        <div style="margin-top: 20px; text-align: center; color: #64748b; font-size: 13px;">
          Порада: Закрийте непотрібні вкладки для кращої організації
        </div>
      `;

      popup.innerHTML = groupsHTML;
      document.body.appendChild(popup);

      // Закриття popup
      document.getElementById('close-organize-popup').addEventListener('click', () => {
        popup.remove();
      });

      // Закриття по кліку поза popup
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      });
    }
    }

    // ========== Система тем ==========
    const settingsBtn = document.getElementById('settings-btn');
    
    if (!settingsBtn) {
      console.error(' Кнопка налаштувань не знайдена!');
    } else {
      console.log(' Кнопка налаштувань знайдена');
    }
    
    // Готові теми
    const themes = {
      light: {
        name: ' Світла',
        colors: {
          '--primary-color': '#3b82f6',
          '--primary-dark': '#1e40af',
          '--primary-light': '#dbeafe',
          '--secondary-color': '#10b981',
          '--background': '#ffffff',
          '--toolbar-bg': '#ffffff',
          '--sidebar-bg': 'linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%)',
          '--text-color': '#1e293b',
          '--border-color': '#e3e8f0',
          '--tab-bg': '#bfdbfe',
          '--tab-active-bg': '#ffffff',
          '--button-hover': '#dbeafe'
        }
      },
      dark: {
        name: ' Темна',
        colors: {
          '--primary-color': '#60a5fa',
          '--primary-dark': '#3b82f6',
          '--primary-light': '#1e3a8a',
          '--secondary-color': '#34d399',
          '--background': '#1e293b',
          '--toolbar-bg': '#0f172a',
          '--sidebar-bg': 'linear-gradient(180deg, #1e293b 0%, #0f172a 100%)',
          '--text-color': '#f1f5f9',
          '--border-color': '#334155',
          '--tab-bg': '#334155',
          '--tab-active-bg': '#475569',
          '--button-hover': '#334155'
        }
      },
      ocean: {
        name: ' Океан',
        colors: {
          '--primary-color': '#06b6d4',
          '--primary-dark': '#0891b2',
          '--primary-light': '#cffafe',
          '--secondary-color': '#14b8a6',
          '--background': '#ecfeff',
          '--toolbar-bg': '#cffafe',
          '--sidebar-bg': 'linear-gradient(180deg, #cffafe 0%, #ecfeff 100%)',
          '--text-color': '#164e63',
          '--border-color': '#a5f3fc',
          '--tab-bg': '#a5f3fc',
          '--tab-active-bg': '#ffffff',
          '--button-hover': '#a5f3fc'
        }
      },
      forest: {
        name: ' Ліс',
        colors: {
          '--primary-color': '#10b981',
          '--primary-dark': '#059669',
          '--primary-light': '#d1fae5',
          '--secondary-color': '#22c55e',
          '--background': '#f0fdf4',
          '--toolbar-bg': '#d1fae5',
          '--sidebar-bg': 'linear-gradient(180deg, #d1fae5 0%, #f0fdf4 100%)',
          '--text-color': '#065f46',
          '--border-color': '#bbf7d0',
          '--tab-bg': '#bbf7d0',
          '--tab-active-bg': '#ffffff',
          '--button-hover': '#bbf7d0'
        }
      },
      sunset: {
        name: ' Захід',
        colors: {
          '--primary-color': '#f59e0b',
          '--primary-dark': '#d97706',
          '--primary-light': '#fef3c7',
          '--secondary-color': '#fb923c',
          '--background': '#fffbeb',
          '--toolbar-bg': '#fef3c7',
          '--sidebar-bg': 'linear-gradient(180deg, #fef3c7 0%, #fffbeb 100%)',
          '--text-color': '#78350f',
          '--border-color': '#fde68a',
          '--tab-bg': '#fde68a',
          '--tab-active-bg': '#ffffff',
          '--button-hover': '#fde68a'
        }
      },
      purple: {
        name: ' Фіолетова',
        colors: {
          '--primary-color': '#a855f7',
          '--primary-dark': '#7e22ce',
          '--primary-light': '#f3e8ff',
          '--secondary-color': '#c084fc',
          '--background': '#faf5ff',
          '--toolbar-bg': '#f3e8ff',
          '--sidebar-bg': 'linear-gradient(180deg, #f3e8ff 0%, #faf5ff 100%)',
          '--text-color': '#581c87',
          '--border-color': '#e9d5ff',
          '--tab-bg': '#e9d5ff',
          '--tab-active-bg': '#ffffff',
          '--button-hover': '#e9d5ff'
        }
      }
    };

    // Застосувати тему
    function applyTheme(themeName) {
      const theme = themes[themeName];
      if (!theme) return;

      const root = document.documentElement;
      Object.keys(theme.colors).forEach(key => {
        root.style.setProperty(key, theme.colors[key]);
      });

      // Зберігаємо вибір
      localStorage.setItem('selectedTheme', themeName);
      showNotification(` Тему "${theme.name}" застосовано!`);
    }

    // Показати панель налаштувань
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        console.log(' Відкриваю налаштування тем');
        showSettingsPopup();
      });
    } else {
      console.error(' Не можу додати обробник - кнопка не знайдена');
    }

    function showSettingsPopup() {
      const currentTheme = localStorage.getItem('selectedTheme') || 'light';
      
      const popup = document.createElement('div');
      popup.id = 'settings-popup';
      popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--background);
        border: 3px solid var(--primary-color);
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000001;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        font-family: 'Segoe UI', sans-serif;
      `;

      let themesHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
          <h2 style="margin: 0; color: var(--primary-color); font-size: 24px;">Налаштування теми</h2>
          <button id="close-settings-popup" style="
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
          "></button>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="color: var(--text-color); margin-bottom: 15px; font-size: 16px;">Виберіть тему:</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
      `;

      Object.keys(themes).forEach(themeKey => {
        const theme = themes[themeKey];
        const isActive = themeKey === currentTheme;
        
        themesHTML += `
          <button class="theme-option" data-theme="${themeKey}" style="
            padding: 16px;
            border: 3px solid ${isActive ? 'var(--primary-color)' : 'var(--border-color)'};
            background: ${isActive ? 'var(--primary-light)' : 'var(--background)'};
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: ${isActive ? 'bold' : 'normal'};
            color: var(--text-color);
            transition: all 0.2s;
            text-align: center;
          ">
            ${theme.name}
          </button>
        `;
      });

      themesHTML += `
          </div>
        </div>

        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--border-color); text-align: center; color: var(--text-color); font-size: 14px;">
          Тема автоматично зберігається
        </div>
      `;

      popup.innerHTML = themesHTML;
      document.body.appendChild(popup);

      // Обробка вибору теми
      popup.querySelectorAll('.theme-option').forEach(btn => {
        btn.addEventListener('click', () => {
          const themeName = btn.dataset.theme;
          applyTheme(themeName);
          
          // Оновлюємо активний стан кнопок
          popup.querySelectorAll('.theme-option').forEach(b => {
            b.style.border = '3px solid var(--border-color)';
            b.style.background = 'var(--background)';
            b.style.fontWeight = 'normal';
          });
          btn.style.border = '3px solid var(--primary-color)';
          btn.style.background = 'var(--primary-light)';
          btn.style.fontWeight = 'bold';
        });

        // Hover ефект
        btn.addEventListener('mouseenter', () => {
          if (btn.dataset.theme !== currentTheme) {
            btn.style.transform = 'scale(1.05)';
            btn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
          }
        });
        btn.addEventListener('mouseleave', () => {
          btn.style.transform = 'scale(1)';
          btn.style.boxShadow = 'none';
        });
      });

      // Закриття popup
      document.getElementById('close-settings-popup').addEventListener('click', () => {
        popup.remove();
      });

      // Закриття по Escape
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          popup.remove();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
    }

    // Завантажуємо збережену тему при старті
    let savedThemeNotes = localStorage.getItem('selectedTheme');
    if (savedThemeNotes && themes[savedThemeNotes]) {
      applyTheme(savedThemeNotes);
    }

    // Застосовуємо збережений стан (за замовчуванням згорнута)
    if (isSidebarCollapsed) {
      notesSidebar.classList.add('collapsed');
      toggleSidebarBtn.textContent = '';
      toggleSidebarBtn.title = 'Показати панель';
    } else {
      notesSidebar.classList.add('expanded');
      toggleSidebarBtn.textContent = '';
      toggleSidebarBtn.title = 'Згорнути панель';
    }

    // Функція toggle для використання всюди
    function toggleSidebar() {
      isSidebarCollapsed = !isSidebarCollapsed;
      
      // Очищаємо inline стилі, щоб CSS класи працювали
      notesSidebar.style.width = '';
      notesSidebar.style.padding = '';
      notesSidebar.style.overflow = '';
      notesSidebar.style.borderLeft = '';
      
      if (isSidebarCollapsed) {
        notesSidebar.classList.remove('expanded');
        notesSidebar.classList.add('collapsed');
      } else {
        notesSidebar.classList.remove('collapsed');
        notesSidebar.classList.add('expanded');
      }
      
      toggleSidebarBtn.textContent = isSidebarCollapsed ? '' : '';
      toggleSidebarBtn.title = isSidebarCollapsed ? 'Показати панель' : 'Згорнути панель';
      localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
      ipcRenderer.send('sidebar-toggled', isSidebarCollapsed);
    }

    // Кнопка в toolbar - використовуємо вже оголошену змінну
    if (toggleSidebarToolbar) {
      toggleSidebarToolbar.addEventListener('click', toggleSidebar);
    }

    // Обробник toggle панелі (кнопка X в заголовку) - використовуємо вже оголошену змінну
    if (toggleSidebarBtn) {
      toggleSidebarBtn.addEventListener('click', toggleSidebar);
    }

    // Гаряча клавіша Ctrl+B для toggle панелі
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        toggleSidebar();
      }
    });

    // Навігація
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        console.log(' Кнопка Назад натиснута');
        ipcRenderer.send('go-back');
      });
    }

    if (forwardBtn) {
      forwardBtn.addEventListener('click', () => {
        console.log(' Кнопка Вперед натиснута');
        ipcRenderer.send('go-forward');
      });
    }

    if (reloadBtn) {
      reloadBtn.addEventListener('click', () => {
        console.log(' Кнопка Оновити натиснута');
        ipcRenderer.send('reload');
      });
    }

    if (urlInput) {
      urlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          console.log(' Навігація до:', urlInput.value);
          ipcRenderer.send('navigate', urlInput.value);
        }
      });
    }

    // Отримуємо текст з контекстного меню (СПІЛЬНІ для всіх вкладок)
    ipcRenderer.on('add-to-notes', (event, text) => {
      addNote(text);
    });

    // Додаємо нотатку (спільну для всіх вкладок)
    function addNote(text) {
      // Видаляємо empty state при першій нотатці
      const emptyState = notesList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const noteId = Date.now().toString(); // Унікальний ID як рядок
      const newNote = { id: noteId, text: text, url: '', createdAt: Date.now() };
      collectedNotes.push(newNote);
      
      const noteItem = document.createElement('div');
      noteItem.className = 'note-item';
      noteItem.dataset.noteId = noteId;
      noteItem.innerHTML = `
        <span>• ${text}</span>
        <button class="delete-btn" onclick="deleteNote('${noteId}')"></button>
      `;
      
      notesList.appendChild(noteItem);
      
      // Зберігаємо в storage через IPC
      ipcRenderer.send('save-note', { text, url: '' });
    }

    // Видалення нотатки
    window.deleteNote = function(noteId) {
      const index = collectedNotes.findIndex(note => note.id === noteId);
      if (index !== -1) {
        collectedNotes.splice(index, 1);
        
        // Видаляємо елемент з DOM
        const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
        if (noteElement) {
          noteElement.remove();
        }
        
        // Показуємо empty state якщо немає нотаток
        if (collectedNotes.length === 0) {
          notesList.innerHTML = '<div class="empty-state">Виділіть текст на сторінці та<br>натисніть праву кнопку миші</div>';
        }
        
        // Видаляємо з storage через IPC
        ipcRenderer.send('delete-note', noteId);
      }
    };

    // Узагальнення через ШІ (використовуємо СПІЛЬНІ нотатки)
    if (summarizeBtn) {
      summarizeBtn.addEventListener('click', async () => {
        if (collectedNotes.length === 0) {
          alert('Конспект порожній! Виділіть текст на сторінці та натисніть праву кнопку миші.');
          return;
        }

        // Витягуємо тільки текст з об'єктів нотаток
        const notesText = collectedNotes.map(note => note.text || note).join('\n---\n');
        const prompt = `Я зібрав наступні нотатки з інтернету. Будь ласка, проаналізуй їх, структуруй, видали дублікати та створи короткий навчальний конспект українською мовою:\n\n${notesText}`;

        summarizeBtn.textContent = ' Думаю...';
        summarizeBtn.disabled = true;

        try {
          const result = await ipcRenderer.invoke('ask-gemini', prompt);
          
          // Замінюємо список на узагальнення
          notesList.innerHTML = `<div style="padding: 10px; line-height: 1.6; white-space: pre-wrap;">${result}</div>`;
          collectedNotes = [];
        } catch (error) {
          alert('Помилка при узагальненні: ' + error.message);
        } finally {
          summarizeBtn.textContent = ' Узагальнити через ШІ';
          summarizeBtn.disabled = false;
        }
      });
    }

    // Очистити все (СПІЛЬНІ нотатки для всіх вкладок)
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (collectedNotes.length === 0 && !notesList.querySelector('.empty-state')) {
          return;
        }
        
        if (confirm('Очистити всі нотатки?')) {
          collectedNotes = [];
          notesList.innerHTML = '<div class="empty-state">Виділіть текст на сторінці та<br>натисніть праву кнопку миші</div>';
          ipcRenderer.send('clear-notes');
        }
      });
    }

    // Обробка зміни мови перекладу
    const translationLanguageSelect = document.getElementById('translation-language');
    if (translationLanguageSelect) {
      translationLanguageSelect.addEventListener('change', (e) => {
        const selectedLanguage = e.target.value;
        console.log(' Вибрано мову перекладу:', selectedLanguage);
        ipcRenderer.send('change-translation-language', selectedLanguage);
      });
    }

    // Simple settings removed — open-settings button deprecated

    // Меню
    const dropdownMenu = document.getElementById('dropdown-menu');
    let currentZoom = 100;

    if (menuBtn && dropdownMenu) {
      // Відкриття/закриття меню
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isNowOpen = !dropdownMenu.classList.contains('active');
        dropdownMenu.classList.toggle('active');
        ipcRenderer.send('menu-toggled', isNowOpen);
      });

      // Закриття меню при кліку поза ним
      document.addEventListener('click', (e) => {
        if (!dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
          if (dropdownMenu.classList.contains('active')) {
            dropdownMenu.classList.remove('active');
            ipcRenderer.send('menu-toggled', false);
          }
        }
      });

      // Закриття меню при натисканні Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dropdownMenu.classList.contains('active')) {
          dropdownMenu.classList.remove('active');
          ipcRenderer.send('menu-toggled', false);
        }
      });

      // Масштаб
      const zoomValue = document.getElementById('zoom-value');
      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const zoomResetBtn = document.getElementById('zoom-reset');
      const fullscreenBtn = document.getElementById('fullscreen');

      if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
          currentZoom = Math.min(currentZoom + 10, 200);
          zoomValue.textContent = currentZoom + '%';
          ipcRenderer.send('set-zoom', currentZoom / 100);
        });
      }

      if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
          currentZoom = Math.max(currentZoom - 10, 50);
          zoomValue.textContent = currentZoom + '%';
          ipcRenderer.send('set-zoom', currentZoom / 100);
        });
      }

      if (zoomResetBtn) {
        zoomResetBtn.addEventListener('click', () => {
          currentZoom = 100;
          zoomValue.textContent = currentZoom + '%';
          ipcRenderer.send('set-zoom', 1);
        });
      }

      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', () => {
          ipcRenderer.send('toggle-fullscreen');
          dropdownMenu.classList.remove('active');
        });
      }

      // Вихід з браузера
      const exitBtn = document.getElementById('exit-browser');
      if (exitBtn) {
        exitBtn.addEventListener('click', () => {
          ipcRenderer.send('window-close');
        });
      }

      // Обробка кліків на пунктах меню
      const menuItems = dropdownMenu.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const label = item.querySelector('.label')?.textContent;
        
        item.addEventListener('click', () => {
          if (label === 'Нова вкладка') {
            createTab();
            dropdownMenu.classList.remove('active');
          } else if (label === 'Нове вікно') {
            ipcRenderer.send('new-window');
            dropdownMenu.classList.remove('active');
          } else if (label === 'Знайти...') {
            // Можна додати функціонал пошуку
            dropdownMenu.classList.remove('active');
          } else if (label === 'Параметри') {
            // Open the theme/customize side panel instead (settings.html removed)
            if (typeof openThemePanel === 'function') openThemePanel();
            dropdownMenu.classList.remove('active');
          } else if (label === 'Завантаження') {
            ipcRenderer.send('open-downloads');
            dropdownMenu.classList.remove('active');
          }
        });
      });
    }

    // Застосування теми
    ipcRenderer.on('theme-changed', (event, theme) => {
      console.log(' Отримано нову тему:', theme.name);
      applyTheme(theme);
    });

    function applyTheme(theme) {
      const colors = theme.colors;
      
      // Застосовуємо CSS змінні
      const root = document.documentElement;
      root.style.setProperty('--primary', colors.primary);
      root.style.setProperty('--background', colors.background);
      root.style.setProperty('--surface', colors.surface);
      root.style.setProperty('--toolbar', colors.toolbar);
      root.style.setProperty('--tab', colors.tab);
      root.style.setProperty('--tab-active', colors.tabActive);
      root.style.setProperty('--text', colors.text);
      root.style.setProperty('--border', colors.border);

      // Застосовуємо стилі безпосередньо
      document.body.style.background = colors.background;
      
      const tabsBar = document.querySelector('.tabs-bar');
      if (tabsBar) tabsBar.style.background = colors.surface;
      
      const toolbar = document.querySelector('.toolbar');
      if (toolbar) toolbar.style.background = colors.toolbar;
      
      // Активна вкладка
      const activeTabs = document.querySelectorAll('.tab.active');
      activeTabs.forEach(tab => {
        tab.style.background = colors.tabActive;
      });

      // Неактивні вкладки
      const inactiveTabs = document.querySelectorAll('.tab:not(.active)');
      inactiveTabs.forEach(tab => {
        tab.style.background = colors.tab;
      });

      // Sidebar
      const sidebar = document.getElementById('notes-sidebar');
      if (sidebar) {
        sidebar.style.background = `linear-gradient(to bottom, ${colors.toolbar} 0%, ${colors.background} 100%)`;
        sidebar.style.borderLeft = `1px solid ${colors.border}`;
      }

      // Organize button
      const organizeBtn = document.getElementById('organize-tabs-btn');
      if (organizeBtn) {
        organizeBtn.style.background = `rgba(16, 185, 129, 0.15)`;
        organizeBtn.style.color = colors.primary;
      }

      console.log(' Тема застосована успішно');
    }

    // Завантаження збереженої теми при старті
    let savedThemeMain = localStorage.getItem('browserTheme');
    if (savedThemeMain) {
      const themes = {
        frutti: {
          name: 'Frutti Di Mare',
          colors: {
            primary: '#f7768e',
            secondary: '#ff9e64',
            tertiary: '#e0af68',
            background: '#1a1b26',
            surface: '#1f2335',
            toolbar: '#24283b',
            tab: '#2f3549',
            tabActive: '#f7768e',
            text: '#c0caf5',
            border: '#414868'
          }
        },
        purple: {
          name: 'Purple Haze',
          colors: {
            primary: '#bb9af7',
            secondary: '#9d7cd8',
            tertiary: '#7aa2f7',
            background: '#1a1b26',
            surface: '#1f2335',
            toolbar: '#24283b',
            tab: '#2f3549',
            tabActive: '#bb9af7',
            text: '#c0caf5',
            border: '#414868'
          }
        },
        vaporwave: {
          name: 'Vaporwave',
          colors: {
            primary: '#2ac3de',
            secondary: '#7dcfff',
            tertiary: '#b4f9f8',
            background: '#1a1b26',
            surface: '#1f2335',
            toolbar: '#24283b',
            tab: '#2f3549',
            tabActive: '#2ac3de',
            text: '#c0caf5',
            border: '#414868'
          }
        }
      };
      
      if (themes[savedThemeMain]) {
        applyTheme(themes[savedThemeMain]);
      }
    }

    // Завантажуємо збережені нотатки при старті (СПІЛЬНІ для всіх вкладок)
    const savedNotes = localStorage.getItem('sharedNotes');
    if (savedNotes) {
      try {
        const parsed = JSON.parse(savedNotes);
        parsed.forEach(note => {
          const text = note.text || note; // Підтримка старого формату
          const noteId = note.id || Date.now() + Math.random();
          
          if (collectedNotes.length === 0) {
            const emptyState = notesList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
          }
          
          collectedNotes.push({ id: noteId, text: text });
          
          const noteItem = document.createElement('div');
          noteItem.className = 'note-item';
          noteItem.dataset.noteId = noteId;
          noteItem.innerHTML = `
            <span>• ${text}</span>
            <button class="delete-btn" onclick="deleteNote(${noteId})"></button>
          `;
          notesList.appendChild(noteItem);
        });
      } catch (e) {
        console.error('Помилка завантаження нотаток:', e);
      }
    }
    
    console.log(' Всі обробники index.html налаштовані');

    // ===================== НОВА ПАНЕЛЬ НАЛАШТУВАНЬ =====================
    const themePanel = document.getElementById('theme-panel');
    const themePanelOverlay = document.getElementById('panel-overlay');
    const themeOpenBtn = document.getElementById('theme-settings-btn');
    const themePanelCloseBtn = document.getElementById('close-panel-btn');
    const themeColorButtons = document.querySelectorAll('.color-option');
    const themeModeButtons = document.querySelectorAll('.mode-btn');

    // Завантажуємо збережені налаштування
    let currentThemeBg = localStorage.getItem('themeBg') || '#1a1b26';
    let currentThemeAccent = localStorage.getItem('themeAccent') || '#3b82f6';
    let currentThemeMode = localStorage.getItem('themeMode') || 'dark';

    // 1. Відкриття панелі
    function openThemePanel() {
      if (themePanel && themePanelOverlay) {
        themePanel.classList.add('open');
        themePanelOverlay.classList.add('active');
        ipcRenderer.send('settings-panel-toggled', true);
      }
    }

    // 2. Закриття панелі
    function closeThemePanel() {
      if (themePanel && themePanelOverlay) {
        themePanel.classList.remove('open');
        themePanelOverlay.classList.remove('active');
        ipcRenderer.send('settings-panel-toggled', false);
      }
    }

    // Обробники відкриття/закриття
    if (themeOpenBtn) themeOpenBtn.addEventListener('click', openThemePanel);
    if (themePanelCloseBtn) themePanelCloseBtn.addEventListener('click', closeThemePanel);
    if (themePanelOverlay) themePanelOverlay.addEventListener('click', closeThemePanel);

    // Закриття по Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && themePanel && themePanel.classList.contains('open')) {
        closeThemePanel();
      }
    });

    // 3. Застосування теми (CSS змінні - магія!)
    function applyBrowserTheme(bg, accent) {
      console.log(' Застосовую тему:', { bg, accent });
      
      // CSS змінні
      document.documentElement.style.setProperty('--theme-bg', bg);
      document.documentElement.style.setProperty('--theme-accent', accent);
      
      // Оновлюємо body (backgroundColor щоб не конфліктувати з backgroundImage шпалерів)
      document.body.style.backgroundColor = bg;
      
      // Toolbar
      const toolbarEl = document.querySelector('.toolbar');
      if (toolbarEl) {
        toolbarEl.style.background = lightenColor(bg, 10);
        toolbarEl.style.borderBottomColor = lightenColor(bg, 20);
      }
      
      // Tabs bar
      const tabsBarEl = document.querySelector('.tabs-bar');
      if (tabsBarEl) {
        tabsBarEl.style.background = lightenColor(bg, 5);
      }

      // Активні вкладки - колір акценту
      document.querySelectorAll('.tab.active').forEach(tab => {
        tab.style.background = accent;
        tab.style.borderColor = accent;
      });
      
      // Неактивні вкладки
      document.querySelectorAll('.tab:not(.active)').forEach(tab => {
        tab.style.background = lightenColor(bg, 15);
        tab.style.borderColor = lightenColor(bg, 25);
      });

      // Address bar
      const addressBar = document.querySelector('.address-bar');
      if (addressBar) {
        addressBar.style.background = bg;
        addressBar.style.borderColor = lightenColor(bg, 30);
      }

      // Dropdown menu
      const dropdownMenu = document.getElementById('dropdown-menu');
      if (dropdownMenu) {
        dropdownMenu.style.background = lightenColor(bg, 5);
        dropdownMenu.style.borderColor = lightenColor(bg, 20);
      }

      // Sidebar
      const sidebar = document.getElementById('notes-sidebar');
      if (sidebar) {
        sidebar.style.background = `linear-gradient(to bottom, ${lightenColor(bg, 10)} 0%, ${bg} 100%)`;
        sidebar.style.borderLeftColor = lightenColor(bg, 20);
      }

      // Organize button - використовуємо accent колір
      const organizeBtn = document.getElementById('organize-tabs-btn');
      if (organizeBtn) {
        organizeBtn.style.background = `rgba(${hexToRgb(accent)}, 0.15)`;
        organizeBtn.style.color = accent;
      }

      // Оновлюємо Preview
      updateThemePreviewBox(bg, accent);

      // Зберігаємо
      localStorage.setItem('themeBg', bg);
      localStorage.setItem('themeAccent', accent);
      currentThemeBg = bg;
      currentThemeAccent = accent;
      
      console.log(' Тема застосована успішно');
    }
    
    // Конвертація HEX в RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? 
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
        '59, 130, 246';
    }

    // Допоміжна функція для освітлення кольору
    function lightenColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + 
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    }

    // Оновлення Preview Box
    function updateThemePreviewBox(bg, accent) {
      const previewBox = document.getElementById('preview-box');
      if (previewBox) {
        previewBox.style.borderColor = accent;
        const previewTab = previewBox.querySelector('.preview-mini-tab');
        const previewContent = previewBox.querySelector('.preview-mini-content');
        const previewToolbar = previewBox.querySelector('.preview-mini-toolbar');
        
        if (previewTab) previewTab.style.background = accent;
        if (previewContent) previewContent.style.background = bg;
        if (previewToolbar) previewToolbar.style.background = lightenColor(bg, 10);
      }
    }

    // 4. Обробка кліку на кольорові кружечки
    themeColorButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const newBg = btn.dataset.bg;
        const newAccent = btn.dataset.accent;
        
        console.log(' Клік на колір:', { newBg, newAccent });

        if (newBg === 'custom' || newAccent === 'custom') {
          // Кастомний колір
          const colorInput = document.createElement('input');
          colorInput.type = 'color';
          colorInput.value = currentThemeAccent;
          colorInput.addEventListener('input', () => {
            applyBrowserTheme(currentThemeBg, colorInput.value);
          });
          colorInput.addEventListener('change', () => {
            applyBrowserTheme(currentThemeBg, colorInput.value);
            updateThemeColorActive(btn);
            // Надсилаємо в main process
            setTimeout(() => {
              if (typeof sendThemeSettings === 'function') sendThemeSettings();
            }, 100);
          });
          colorInput.click();
        } else if (newBg && newAccent) {
          applyBrowserTheme(newBg, newAccent);
          updateThemeColorActive(btn);
          // Надсилаємо в main process
          setTimeout(() => {
            if (typeof sendThemeSettings === 'function') sendThemeSettings();
          }, 100);
        }
      });
    });

    function updateThemeColorActive(activeBtn) {
      document.querySelectorAll('.color-option').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }

    // 5. Світла/Темна тема
    themeModeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        themeModeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const mode = btn.getAttribute('data-mode');
        currentThemeMode = mode;
        localStorage.setItem('themeMode', mode);
        
        if (mode === 'light') {
          applyBrowserTheme('#f5f5f5', currentThemeAccent);
          document.documentElement.style.setProperty('--theme-text', '#1f2937');
          document.documentElement.style.setProperty('--theme-surface', '#ffffff');
        } else if (mode === 'dark') {
          applyBrowserTheme('#1a1b26', currentThemeAccent);
          document.documentElement.style.setProperty('--theme-text', '#c0caf5');
          document.documentElement.style.setProperty('--theme-surface', '#24283b');
        } else {
          // System
          const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (isDark) {
            applyBrowserTheme('#1a1b26', currentThemeAccent);
          } else {
            applyBrowserTheme('#f5f5f5', currentThemeAccent);
          }
        }
        
        // Надсилаємо в main process
        setTimeout(() => {
          if (typeof sendThemeSettings === 'function') sendThemeSettings();
        }, 100);
      });
    });

    // 6. Toggle switches
    document.querySelectorAll('.toggle-switch').forEach(toggle => {
      toggle.addEventListener('click', () => {
        toggle.classList.toggle('active');
      });
    });

    // 7. Відкриття з меню
    const customizeMenuItem = document.getElementById('customize-menu');
    if (customizeMenuItem) {
      customizeMenuItem.addEventListener('click', () => {
        const dropdownMenu = document.getElementById('dropdown-menu');
        if (dropdownMenu) dropdownMenu.classList.remove('active');
        ipcRenderer.send('menu-toggled', false);
        openThemePanel();
      });
    }

    // 8. Завантажуємо збережену тему при старті
    applyBrowserTheme(currentThemeBg, currentThemeAccent);
    
    // Встановлюємо активний режим
    themeModeButtons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.mode === currentThemeMode) {
        btn.classList.add('active');
      }
    });

    // Встановлюємо активний колір
    themeColorButtons.forEach(btn => {
      if (btn.dataset.accent === currentThemeAccent) {
        btn.classList.add('active');
      }
    });

    // ========== WALLPAPERS SECTION ==========
    const wallpaperCards = document.querySelectorAll('.wallpaper-card[data-wallpaper]');
    const uploadWallpaperCard = document.getElementById('upload-wallpaper');
    const uploadWallpaperBtn = document.getElementById('upload-wallpaper-btn');
    const clearWallpaperBtn = document.getElementById('clear-wallpaper');
    const wallpaperFileInput = document.getElementById('wallpaper-file-input');

    let currentWallpaper = localStorage.getItem('wallpaper') || 'none';

    // Функція для надсилання налаштувань теми в main process
    function sendThemeSettings() {
      ipcRenderer.send('update-theme-settings', {
        mode: currentThemeMode,
        bg: currentThemeBg,
        accent: currentThemeAccent,
        wallpaper: currentWallpaper
      });
    }

    // Застосування шпалерів
    function applyWallpaper(wallpaperData) {
      if (!wallpaperData || wallpaperData === 'none') {
        localStorage.removeItem('wallpaper');
        currentWallpaper = 'none';
      } else {
        localStorage.setItem('wallpaper', wallpaperData);
        currentWallpaper = wallpaperData;
      }

      // Оновлюємо активний стан карток в панелі
      updateWallpaperActive(wallpaperData);
      
      // Надсилаємо налаштування в main process для newtab
      sendThemeSettings();
      
      console.log(' Шпалери змінено:', wallpaperData);
    }

    // Оновлення активної картки
    function updateWallpaperActive(wallpaperData) {
      wallpaperCards.forEach(card => card.classList.remove('active'));
      
      if (!wallpaperData || wallpaperData === 'none') {
        const noneCard = document.querySelector('[data-wallpaper="none"]');
        if (noneCard) noneCard.classList.add('active');
      } else if (wallpaperData.startsWith('data:') || wallpaperData.startsWith('http')) {
        uploadWallpaperCard.classList.add('active');
      } else {
        const activeCard = document.querySelector(`[data-wallpaper="${wallpaperData}"]`);
        if (activeCard) activeCard.classList.add('active');
      }
    }

    // Клік на картки шпалерів
    wallpaperCards.forEach(card => {
      card.addEventListener('click', () => {
        const wallpaper = card.dataset.wallpaper;
        applyWallpaper(wallpaper);
      });
    });

    // Завантаження кастомних шпалерів
    if (uploadWallpaperCard) {
      uploadWallpaperCard.addEventListener('click', () => {
        wallpaperFileInput.click();
      });
    }

    if (uploadWallpaperBtn) {
      uploadWallpaperBtn.addEventListener('click', () => {
        wallpaperFileInput.click();
      });
    }

    if (wallpaperFileInput) {
      wallpaperFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Перевірка розміру (макс 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Файл занадто великий! Максимум 5 МБ.');
          return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
          const imageData = event.target.result;
          applyWallpaper(imageData);
        };
        reader.readAsDataURL(file);
      });
    }

    // Очистити шпалери
    if (clearWallpaperBtn) {
      clearWallpaperBtn.addEventListener('click', () => {
        applyWallpaper('none');
      });
    }

    // Завантажити збережені шпалери при старті (тільки оновлюємо UI карток)
    updateWallpaperActive(currentWallpaper);
    
    // Надсилаємо початкові налаштування теми в main process
    sendThemeSettings();
    
    console.log(' Панель налаштувань готова');

    // ===================== END ПАНЕЛЬ НАЛАШТУВАНЬ =====================

    // ===================== TOR INTEGRATION =====================
    const torBtn = document.getElementById('tor-btn');
    
    // Функція для показу повідомлень
    function showTorNotification(message) {
      console.log('Tor:', message);
      // Можна додати красиве сповіщення пізніше
    }
    
    if (torBtn) {
      // Завантажуємо початковий статус
      ipcRenderer.invoke('get-tor-status').then(status => {
        const urlInput = document.getElementById('url');
        
        if (status.active) {
          torBtn.textContent = 'Tor: ON';
          torBtn.style.color = '#8b5cf6';
          if (urlInput) {
            urlInput.placeholder = 'DuckDuckGo пошук або введіть адресу';
          }
        } else {
          torBtn.textContent = 'Tor: OFF';
          torBtn.style.color = '#9ca3af';
          if (urlInput) {
            urlInput.placeholder = 'Google пошук або введіть адресу';
          }
        }
      }).catch(err => {
        console.error('Помилка отримання статусу Tor:', err);
        torBtn.textContent = 'Tor: OFF';
        torBtn.style.color = '#9ca3af';
      });
      
      // Обробник кліку
      torBtn.addEventListener('click', async () => {
        torBtn.textContent = 'Підключення...';
        torBtn.disabled = true;
        
        try {
          const result = await ipcRenderer.invoke('toggle-tor');
          
          if (result.status) {
            torBtn.textContent = 'Tor: ON';
            torBtn.style.color = '#8b5cf6';
          } else {
            torBtn.textContent = 'Tor: OFF';
            torBtn.style.color = '#9ca3af';
          }
          
          // Показуємо повідомлення
          showTorNotification(result.message);
        } catch (error) {
          console.error('Помилка перемикання Tor:', error);
          torBtn.textContent = 'Tor: OFF';
          torBtn.style.color = '#dc2626';
          showTorNotification('Помилка підключення Tor');
        } finally {
          torBtn.disabled = false;
        }
      });
    }
    
    // Слухаємо готовність Tor
    ipcRenderer.on('tor-ready', (event, ready) => {
      if (ready && torBtn) {
        console.log('Tor готовий до використання');
      }
    });
    
    // Слухаємо зміну пошукової системи при перемиканні Tor
    ipcRenderer.on('update-search-engine', (event, searchEngine) => {
      const urlInput = document.getElementById('url');
      if (urlInput) {
        urlInput.placeholder = `${searchEngine} пошук або введіть адресу`;
        console.log('[SEARCH] Пошукова система змінена на:', searchEngine);
      }
    });
    
    // ===================== END TOR INTEGRATION =====================
    
  } catch (error) {
    console.error(' КРИТИЧНА ПОМИЛКА в index.html:', error);
    alert('Помилка завантаження браузера: ' + error.message);
  }
  </script>
</body>
</html>
