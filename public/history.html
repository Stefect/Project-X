<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
  <title>–Ü—Å—Ç–æ—Ä—ñ—è - BrowserX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);
      color: #fff;
      padding: 40px 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    h1 {
      font-size: 32px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .search-box {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      padding: 10px 15px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 14px;
      width: 300px;
      outline: none;
      transition: all 0.3s;
    }

    .search-input:focus {
      border-color: #3b82f6;
      background: rgba(59,130,246,0.1);
    }

    .clear-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .clear-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(239,68,68,0.4);
    }

    .history-list {
      display: grid;
      gap: 15px;
    }

    .history-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .history-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: #3b82f6;
      transform: translateX(5px);
    }

    .favicon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-url {
      font-size: 13px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-time {
      font-size: 12px;
      color: #666;
      flex-shrink: 0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .delete-btn {
      padding: 6px 12px;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 6px;
      color: #ef4444;
      cursor: pointer;
      font-size: 12px;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:hover .delete-btn {
      opacity: 1;
    }

    .delete-btn:hover {
      background: rgba(239,68,68,0.3);
    }

    .group-header {
      font-size: 14px;
      font-weight: 600;
      color: #888;
      margin: 25px 0 10px 0;
      padding-left: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö –Ü—Å—Ç–æ—Ä—ñ—è –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤</h1>
      <div class="search-box">
        <input type="text" class="search-input" id="search-input" placeholder="–ü–æ—à—É–∫ –ø–æ —ñ—Å—Ç–æ—Ä—ñ—ó...">
        <button class="clear-btn" id="clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
      </div>
    </div>

    <div class="history-list" id="history-list">
      <div class="empty-state">
        <div class="empty-icon">üïê</div>
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</p>
      </div>
    </div>
  </div>

  <script>
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ API —á–µ—Ä–µ–∑ preload
    const historyList = document.getElementById('history-list');
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-btn');

    let allHistory = [];

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
    async function loadHistory() {
      allHistory = await window.browserStorage.getHistory(1000);
      renderHistory(allHistory);
    }

    // –§–æ—Ä–º–∞—Ç—É—î–º–æ —á–∞—Å
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return '–©–æ–π–Ω–æ';
      if (minutes < 60) return `${minutes} —Ö–≤ —Ç–æ–º—É`;
      if (hours < 24) return `${hours} –≥–æ–¥ —Ç–æ–º—É`;
      if (days < 7) return `${days} –¥–Ω —Ç–æ–º—É`;
      
      return date.toLocaleDateString('uk-UA');
    }

    // –ì—Ä—É–ø—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ –¥–∞—Ç–∞—Ö
    function groupByDate(history) {
      const groups = {
        today: [],
        yesterday: [],
        week: [],
        older: []
      };

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);

      history.forEach(item => {
        const itemDate = new Date(item.visitedAt);
        if (itemDate >= today) {
          groups.today.push(item);
        } else if (itemDate >= yesterday) {
          groups.yesterday.push(item);
        } else if (itemDate >= weekAgo) {
          groups.week.push(item);
        } else {
          groups.older.push(item);
        }
      });

      return groups;
    }

    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
    function renderHistory(history) {
      if (history.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>
          </div>
        `;
        return;
      }

      const groups = groupByDate(history);
      let html = '';

      if (groups.today.length > 0) {
        html += '<div class="group-header">–°—å–æ–≥–æ–¥–Ω—ñ</div>';
        groups.today.forEach(item => html += createHistoryItem(item));
      }

      if (groups.yesterday.length > 0) {
        html += '<div class="group-header">–í—á–æ—Ä–∞</div>';
        groups.yesterday.forEach(item => html += createHistoryItem(item));
      }

      if (groups.week.length > 0) {
        html += '<div class="group-header">–¶—å–æ–≥–æ —Ç–∏–∂–Ω—è</div>';
        groups.week.forEach(item => html += createHistoryItem(item));
      }

      if (groups.older.length > 0) {
        html += '<div class="group-header">–†–∞–Ω—ñ—à–µ</div>';
        groups.older.forEach(item => html += createHistoryItem(item));
      }

      historyList.innerHTML = html;
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ HTML –µ–ª–µ–º–µ–Ω—Ç —ñ—Å—Ç–æ—Ä—ñ—ó
    function createHistoryItem(item) {
      const faviconUrl = item.favicon || getFaviconFromUrl(item.url);
      const escapedUrl = escapeHtml(item.url).replace(/'/g, '&apos;');
      return `
        <div class="history-item" data-url="${escapedUrl}">
          <img class="favicon" src="${faviconUrl}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>üåê</text></svg>'">
          <div class="history-content">
            <div class="history-title">${escapeHtml(item.title)}</div>
            <div class="history-url">${escapeHtml(item.url)}</div>
          </div>
          <div class="history-time">${formatTime(item.visitedAt)}</div>
          <button class="delete-btn" data-url="${escapedUrl}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
      `;
    }

    // –û—Ç—Ä–∏–º—É—î–º–æ favicon –∑ URL
    function getFaviconFromUrl(url) {
      try {
        const urlObj = new URL(url);
        return `${urlObj.origin}/favicon.ico`;
      } catch {
        return 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>üåê</text></svg>';
      }
    }

    // –ï–∫—Ä–∞–Ω—É—î–º–æ HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ URL
    function openUrl(url) {
      window.browserStorage.openUrl(url);
    }

    // –í–∏–¥–∞–ª—è—î–º–æ –µ–ª–µ–º–µ–Ω—Ç
    function deleteItem(url) {
      if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å –∑ —ñ—Å—Ç–æ—Ä—ñ—ó?')) {
        allHistory = allHistory.filter(item => item.url !== url);
        renderHistory(allHistory);
        // –í–∏–¥–∞–ª—è—î–º–æ –∑ storage
        window.browserStorage.deleteHistoryItem(url);
      }
    }

    // –ü–æ—à—É–∫
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      if (!query) {
        renderHistory(allHistory);
        return;
      }

      const filtered = allHistory.filter(item => 
        item.title.toLowerCase().includes(query) ||
        item.url.toLowerCase().includes(query)
      );
      renderHistory(filtered);
    });

    // Event delegation –¥–ª—è –∫–ª—ñ–∫—ñ–≤ –Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—é
    historyList.addEventListener('click', (e) => {
      const historyItem = e.target.closest('.history-item');
      const deleteBtn = e.target.closest('.delete-btn');

      if (deleteBtn && historyItem) {
        // –ö–ª—ñ–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        e.stopPropagation();
        const url = deleteBtn.dataset.url.replace(/&apos;/g, "'");
        deleteItem(url);
      } else if (historyItem && !deleteBtn) {
        // –ö–ª—ñ–∫ –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç —ñ—Å—Ç–æ—Ä—ñ—ó
        const url = historyItem.dataset.url.replace(/&apos;/g, "'");
        openUrl(url);
      }
    });

    // –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
    clearBtn.addEventListener('click', async () => {
      if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é?')) {
        window.browserStorage.clearHistory();
        allHistory = [];
        renderHistory([]);
      }
    });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    loadHistory();
  </script>
</body>
</html>
